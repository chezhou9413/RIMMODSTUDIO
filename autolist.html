<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ¨ªå‘æ’åˆ—å›¾é›† â€” ç²¾çµå¸§å¯¼å‡ºä¸é¢„è§ˆ</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#3b82f6}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#071025 0%,#07152a 100%);color:#e6eef8;padding:18px;box-sizing:border-box}
    h1{margin:0 0 8px;font-size:18px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .btn{background:var(--card);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--accent);color:white;border:none}
    .drop{border:2px dashed rgba(255,255,255,0.06);padding:18px;border-radius:10px;display:flex;align-items:center;gap:12px}
    .drop.dragover{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.4)}
    .gallery{display:flex;gap:10px;overflow-x:auto;padding:12px 6px;margin-top:12px}
    .thumb{min-width:160px;height:120px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.12));border-radius:8px;padding:8px;box-sizing:border-box;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
    .thumb img{max-width:100%;max-height:72px;border-radius:6px;object-fit:cover}
    .thumb .name{font-size:12px;color:var(--muted);margin-top:6px;word-break:break-all;text-align:center}
    .thumb .remove{position:absolute;right:6px;top:6px;background:rgba(0,0,0,0.4);border-radius:6px;padding:4px;cursor:pointer}
    .hint{font-size:13px;color:var(--muted)}
    .spacer{flex:1}
    input[type=file]{display:none}
    .controls{display:flex;gap:8px;align-items:center}
    .options{display:flex;gap:10px;align-items:center;margin-left:8px}
    .previewWrap{margin-top:14px;display:flex;gap:12px;align-items:flex-start}
    .previewArea{background:#071827;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
    .previewArea img{max-width:100%;height:auto;display:block}
    label.small{font-size:12px;color:var(--muted)}
    input[type=number]{width:80px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
    @media (max-width:800px){.previewWrap{flex-direction:column}}
  </style>
</head>
<body>
  <h1>æ¨ªå‘æ’åˆ—å›¾é›† â€” ç²¾çµå¸§å¯¼å‡ºä¸é¢„è§ˆ</h1>
  <div class="toolbar">
    <label class="btn" for="fileInput">ğŸ“ é€‰æ‹©å›¾ç‰‡</label>
    <input id="fileInput" type="file" accept="image/*" multiple>
    <button class="btn" id="clearBtn">ğŸ§¹ æ¸…é™¤å›¾é›†</button>
    <button class="btn primary" id="exportSpriteBtn">ğŸ–¼ï¸ å¯¼å‡ºç²¾çµå¸§ (PNG)</button>
    <button class="btn" id="previewSpriteBtn">ğŸ” é¢„è§ˆç²¾çµå¸§</button>

    <div class="spacer"></div>

    <label class="btn" id="importLabel">ğŸ” å¯¼å…¥ï¼ˆæŒ‰æ–‡ä»¶åè‡ªåŠ¨æ’åºï¼‰
      <input id="importInput" type="file" accept="image/*" multiple style="display:none">
    </label>
  </div>

  <div id="dropzone" class="drop">
    <div style="flex:1">
      <div class="hint">æŠŠå›¾ç‰‡æ‹–æ”¾åˆ°è¿™é‡Œä¸Šä¼ ï¼Œæˆ–ç‚¹å‡»â€œé€‰æ‹©å›¾ç‰‡â€ã€‚å¯¼å…¥ï¼ˆå³ä¾§æŒ‰é’®ï¼‰ä¼šæ ¹æ®æ–‡ä»¶åè¿›è¡Œæ’åºå†åŠ å…¥ã€‚æ”¯æŒ PNG/JPG/GIFã€‚</div>
    </div>
    <div style="min-width:140px;text-align:right;color:var(--muted)">å½“å‰: <span id="count">0</span> å¼ </div>
  </div>

  <div id="gallery" class="gallery" aria-label="å›¾ç‰‡ç”»å»Š"></div>

  <div class="previewWrap">
    <div class="previewArea" style="flex:1">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label class="small">é—´éš”(px)</label>
        <input id="gapInput" type="number" min="0" value="0">
        <label class="small">è¾¹è·(px)</label>
        <input id="paddingInput" type="number" min="0" value="0">
        <label class="small">ç¼©æ”¾(%)</label>
        <input id="scaleInput" type="number" min="10" max="1000" value="100">
      </div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">é¢„è§ˆï¼ˆç‚¹å‡»â€œé¢„è§ˆç²¾çµå¸§â€ç”Ÿæˆï¼‰ï¼š</div>
      <div id="previewContainer" style="min-height:120px;display:flex;align-items:center;justify-content:center">
        <div style="color:var(--muted)">å°šæœªç”Ÿæˆé¢„è§ˆ</div>
      </div>
    </div>
    <div style="width:320px;max-width:40%;min-width:260px">
      <div style="background:#071827;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
        <div style="font-weight:600;margin-bottom:8px">å¯¼å‡ºä¿¡æ¯</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:6px">å¯¼å‡ºæ—¶ä¼šæŒ‰å½“å‰ç”»å»Šé¡ºåºåˆå¹¶ä¸ºä¸€å¼ æ¨ªå‘ç²¾çµå›¾ï¼Œæ–‡ä»¶ä¸º PNG æ ¼å¼ã€‚æ–‡ä»¶åä¼šåŒ…å«æ—¶é—´æˆ³ã€‚</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button class="btn" id="downloadMetaBtn">â¬‡ï¸ ä¸‹è½½é¢„è§ˆå›¾ (å¦å­˜ä¸º PNG)</button>
        </div>
        <div style="margin-top:12px;font-size:13px;color:var(--muted)">æç¤ºï¼šè‹¥å›¾ç‰‡å°ºå¯¸ä¸åŒï¼Œä¼šæŒ‰å›¾é«˜å¯¹é½å¹¶åœ¨é¡¶éƒ¨å±…ä¸­ï¼ˆå¯ç”¨è¾¹è·è°ƒæ•´ï¼‰ã€‚</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const importInput = document.getElementById('importInput');
    const gallery = document.getElementById('gallery');
    const dropzone = document.getElementById('dropzone');
    const countSpan = document.getElementById('count');
    const clearBtn = document.getElementById('clearBtn');
    const exportSpriteBtn = document.getElementById('exportSpriteBtn');
    const previewSpriteBtn = document.getElementById('previewSpriteBtn');
    const gapInput = document.getElementById('gapInput');
    const paddingInput = document.getElementById('paddingInput');
    const scaleInput = document.getElementById('scaleInput');
    const previewContainer = document.getElementById('previewContainer');
    const downloadMetaBtn = document.getElementById('downloadMetaBtn');

    // å­˜å‚¨é¡¹: {id, name, dataUrl, img (Image object), width, height, file}
    let items = [];

    function updateCount(){ countSpan.textContent = items.length }

    function render(){
      gallery.innerHTML = '';
      items.forEach(it => {
        const el = document.createElement('div');
        el.className = 'thumb';
        el.draggable = false;
        el.dataset.id = it.id;
        el.innerHTML = `
          <button class="remove" title="ç§»é™¤">âœ–</button>
          <img src="${it.dataUrl}" alt="${escapeHtml(it.name)}">
          <div class="name">${escapeHtml(it.name)}</div>
        `;
        el.querySelector('.remove').addEventListener('click',()=>{
          items = items.filter(x=>x.id!==it.id);
          render(); updateCount();
        });
        gallery.appendChild(el);
      });
    }

    function escapeHtml(s){ return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

    function fileToItem(file){
      return new Promise((res,rej)=>{
        const reader = new FileReader();
        reader.onload = async e => {
          const dataUrl = e.target.result;
          const img = new Image();
          img.onload = () => {
            res({id:cryptoRandomId(), name:file.name, dataUrl, img, width:img.width, height:img.height, file});
          };
          img.onerror = rej;
          img.src = dataUrl;
        };
        reader.onerror = rej;
        reader.readAsDataURL(file);
      });
    }

    function cryptoRandomId(){ return Math.random().toString(36).slice(2,9) }

    async function handleFiles(fileList, sortByName=false){
      let files = Array.from(fileList);
      if(sortByName) files.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));
      const results = await Promise.all(files.map(f=>fileToItem(f)));
      items = items.concat(results);
      render(); updateCount();
    }

    // dropzone handlers
    ;['dragenter','dragover'].forEach(ev=>{
      dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.classList.add('dragover')})
    });
    ;['dragleave','drop'].forEach(ev=>{
      dropzone.addEventListener(ev,e=>{e.preventDefault();dropzone.classList.remove('dragover')})
    });
    dropzone.addEventListener('drop', e=>{
      const dt = e.dataTransfer;
      if(dt && dt.files && dt.files.length) handleFiles(dt.files, false);
    });

    fileInput.addEventListener('change', e=>{
      if(e.target.files.length) handleFiles(e.target.files, false);
      e.target.value = '';
    });

    importInput.addEventListener('change', e=>{
      if(e.target.files.length) handleFiles(e.target.files, true);
      e.target.value = '';
    });

    clearBtn.addEventListener('click', ()=>{
      if(!confirm('ç¡®å®šè¦æ¸…ç©ºå›¾é›†å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) return;
      items = [];
      render(); updateCount();
      previewContainer.innerHTML = '<div style="color:var(--muted)">å°šæœªç”Ÿæˆé¢„è§ˆ</div>';
    });

    // Sortable åˆå§‹åŒ–ï¼ˆæ°´å¹³ï¼‰
    const sortable = new Sortable(gallery, {
      animation:150,
      direction: 'horizontal',
      draggable: '.thumb',
      onEnd: ()=>{
        const ids = Array.from(gallery.children).map(c=>c.dataset.id);
        items = ids.map(id => items.find(it=>it.id===id)).filter(Boolean);
      }
    });

    // ç”Ÿæˆç²¾çµå¸§ï¼ˆæ¨ªå‘åˆå¹¶ï¼‰
    async function generateSprite({gap=0,padding=0,scale=1,returnBlob=false}={}){
      if(items.length===0) throw new Error('æ²¡æœ‰å›¾ç‰‡å¯ç”¨äºç”Ÿæˆç²¾çµå¸§');
      // æŒ‰å½“å‰é¡ºåºè®¡ç®—å°ºå¯¸
      const widths = items.map(it=>Math.round(it.width * scale));
      const heights = items.map(it=>Math.round(it.height * scale));
      const totalWidth = widths.reduce((a,b)=>a+b,0) + gap*(items.length-1) + padding*2;
      const maxHeight = Math.max(...heights) + padding*2;

      const canvas = document.createElement('canvas');
      canvas.width = totalWidth;
      canvas.height = maxHeight;
      const ctx = canvas.getContext('2d');
      // èƒŒæ™¯é€æ˜
      ctx.clearRect(0,0,canvas.width,canvas.height);

      let x = padding;
      for(let i=0;i<items.length;i++){
        const it = items[i];
        const w = Math.round(it.width * scale);
        const h = Math.round(it.height * scale);
        // å‚ç›´å±…ä¸­ç»˜åˆ¶ï¼ˆä½äºç”»å¸ƒä¸­çº¿ï¼‰
        const y = padding + Math.round((maxHeight - padding*2 - h)/2);
        // ç”»å›¾ï¼ˆå¦‚æœéœ€è¦ç¼©æ”¾ï¼Œä½¿ç”¨ drawImage çš„å®½é«˜å‚æ•°ï¼‰
        ctx.drawImage(it.img, 0,0,it.width,it.height, x, y, w, h);
        x += w + gap;
      }

      if(returnBlob){
        return await new Promise(res=>canvas.toBlob(b=>res(b), 'image/png'));
      }
      return canvas;
    }

    // é¢„è§ˆ
    previewSpriteBtn.addEventListener('click', async ()=>{
      try{
        const gap = Math.max(0, Number(gapInput.value)||0);
        const padding = Math.max(0, Number(paddingInput.value)||0);
        const scale = Math.max(0.01, (Number(scaleInput.value)||100)/100);
        const canvas = await generateSprite({gap, padding, scale, returnBlob:false});
        previewContainer.innerHTML = '';
        const img = document.createElement('img');
        img.src = canvas.toDataURL('image/png');
        img.alt = 'sprite-preview';
        previewContainer.appendChild(img);
      }catch(err){
        alert(err.message || 'ç”Ÿæˆé¢„è§ˆæ—¶å‡ºé”™');
      }
    });

    // å¯¼å‡º PNG
    exportSpriteBtn.addEventListener('click', async ()=>{
      try{
        if(items.length===0){ alert('æ²¡æœ‰å›¾ç‰‡å¯å¯¼å‡º'); return }
        const gap = Math.max(0, Number(gapInput.value)||0);
        const padding = Math.max(0, Number(paddingInput.value)||0);
        const scale = Math.max(0.01, (Number(scaleInput.value)||100)/100);
        const blob = await generateSprite({gap, padding, scale, returnBlob:true});
        const filename = `sprite-${new Date().toISOString().slice(0,19).replaceAll(':','')}.png`;
        downloadBlob(blob, filename);
      }catch(err){
        alert(err.message || 'å¯¼å‡ºç²¾çµå¸§å¤±è´¥');
      }
    });

    // ä¸‹è½½é¢„è§ˆï¼ˆå½“å‰é¢„è§ˆå†…å®¹ï¼‰
    downloadMetaBtn.addEventListener('click', async ()=>{
      try{
        // å¦‚æœå·²ç»æœ‰é¢„è§ˆ imgï¼Œç›´æ¥ä¸‹è½½å…¶ dataURLï¼Œå¦åˆ™ç”Ÿæˆä¸€æ¬¡
        const imgEl = previewContainer.querySelector('img');
        if(imgEl){
          const dataUrl = imgEl.src;
          const blob = dataURLtoBlob(dataUrl);
          downloadBlob(blob, `sprite-preview-${new Date().toISOString().slice(0,19).replaceAll(':','')}.png`);
          return;
        }
        // ç”Ÿæˆå¹¶ä¸‹è½½
        const gap = Math.max(0, Number(gapInput.value)||0);
        const padding = Math.max(0, Number(paddingInput.value)||0);
        const scale = Math.max(0.01, (Number(scaleInput.value)||100)/100);
        const blob = await generateSprite({gap, padding, scale, returnBlob:true});
        downloadBlob(blob, `sprite-preview-${new Date().toISOString().slice(0,19).replaceAll(':','')}.png`);
      }catch(err){
        alert('ä¸‹è½½é¢„è§ˆå¤±è´¥ï¼š' + (err.message||err));
      }
    });

    function dataURLtoBlob(dataurl){
      const arr = dataurl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while(n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], {type:mime});
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    // åˆå§‹æ¸²æŸ“
    render(); updateCount();
  </script>
</body>
</html>